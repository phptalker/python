 # -*- coding: utf-8 -*-import confimport timeimport MySQLdbimport smtplibfrom email.mime.text import MIMETextimport datetimeimport traceback############## 要发给谁，这里发给2个人mailto_list =   ["wangxianghong@looip.cn","robert@looip.cn"]table_list  =   [{"tableName":"act_flow0"       ,"primaryKey":'id','timeColumn':'time'}                    ,{"tableName":'advert'      ,"primaryKey":'id','timeColumn':'created_at'}                    ,{"tableName":'advice'      ,"primaryKey":'id','timeColumn':'created_at'}                    ,{"tableName":'article'     ,"primaryKey":'id','timeColumn':'created_at'}                    ,{"tableName":'bespeak'     ,"primaryKey":'bespeak_id','timeColumn':'created_at'}                     ,{"tableName":'alipay_log',"primaryKey":'id','timeColumn':'created_at'}                   #  ,{"tableName":'answer'     ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'bespeak_log',"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'daily_report',"primaryKey":'id','timeColumn':'date'}                     ,{"tableName":'job_schedule',"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'link'       ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'notice'     ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'order'      ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'order_log'  ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'order_paid_history',"primaryKey":'id','timeColumn':'paid_time'}                     ,{"tableName":'order_refund_history'    ,"primaryKey":'id','timeColumn':'refund_time'}                     ,{"tableName":'pay_account'    ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'programmer_profile'    ,"primaryKey":'profile_id','timeColumn':'created_at'}                     ,{"tableName":'project_demand'    ,"primaryKey":'demand_id','timeColumn':'created_at'}                     ,{"tableName":'publication'    ,"primaryKey":'id','timeColumn':'created_at'}                     #,{"tableName":'question'    ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'score_detail'    ,"primaryKey":'id','timeColumn':'time'}                     ,{"tableName":'score_order'    ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'share_detail'    ,"primaryKey":'id','timeColumn':'time'}                     ,{"tableName":'sms_code'    ,"primaryKey":'code_id','timeColumn':'send_time'}                     ,{"tableName":'sms_notify'    ,"primaryKey":'notify_id','timeColumn':'created_at'}                     ,{"tableName":'statistics'    ,"primaryKey":'id','timeColumn':'time'}                     ,{"tableName":'trans_flow'    ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'user'    ,"primaryKey":'user_id','timeColumn':'created_at'}                     ,{"tableName":'user_profile'    ,"primaryKey":'id','timeColumn':'created_at'}                     ,{"tableName":'user_score'    ,"primaryKey":'id','timeColumn':''}                     ,{"tableName":'user_search_log'    ,"primaryKey":'id','timeColumn':'time'}                     ,{"tableName":'user_session'    ,"primaryKey":'session_id','timeColumn':'created_at'}                      ,{"tableName":'user_setting'    ,"primaryKey":'id','timeColumn':'created_at'}                      ,{"tableName":'user_statistics'    ,"primaryKey":'id','timeColumn':''}                      ,{"tableName":'uuid2source'    ,"primaryKey":'id','timeColumn':'create_at'}                      ,{"tableName":'uuid2uid'    ,"primaryKey":'id','timeColumn':''}               ]###################### 设置服务器，用户名、口令以及邮箱的后缀mail_host = "smtp.sina.com"mail_user = "hong1070"mail_pass = "hong97850014"mail_postfix = "sina.com"def conndb():    return MySQLdb.connect(host=conf.mysql_host, user=conf.mysql_user, passwd=conf.mysql_pwd, db=conf.mysql_db,                           port=int(conf.mysql_port))######################def send_mail(to_list, sub, content):    '''''    to_list:发给谁    sub:主题    content:内容    send_mail("aaa@126.com","sub","content")    '''    me = mail_user + "<" + mail_user + "@" + mail_postfix + ">"    msg = MIMEText(content, 'html', 'utf-8')    msg['Subject'] = sub    msg['From'] = me    msg['To'] = ";".join(to_list)    try:        s = smtplib.SMTP()        s.connect(mail_host)        s.login(mail_user, mail_pass)        s.sendmail(me, to_list, msg.as_string())        s.close()        return True    except Exception, e:        print str(e)        return Falsedef checkData():    conn = conndb()    cursor = conn.cursor()    try:        cursor.execute('set names utf8')        today = datetime.date.today()        beforeYesterday =  today - datetime.timedelta(days=2)        yesterday =  today - datetime.timedelta(days=1)        # yesterday = beforeYesterday        #today = yesterday        emailDesc = ''        emailContent = '<table border ="1" ><th>表名</th><th>增加值</th>';        for table in table_list:            tableName  = table['tableName']            primaryKey =  table['primaryKey']            yesterdayDataSql = 'select date,tableName,maxId from tableMonitor where date = %s and tableName = %s'            cursor.execute(yesterdayDataSql , [yesterday ,tableName])            yesterdayData = cursor.fetchone();            if(yesterdayData == None):                currtime = time.strftime("%Y-%m-%d %H:%I:%S", time.localtime())                maxIdSql = "select max(`"+primaryKey +"`) from `"+tableName+"` "                if table['timeColumn']:                    maxIdSql += 'where ' + table['timeColumn'] + '< '  "'"+today.strftime("%Y-%m-%d") +"'"                maxIdSql  += "  limit 0,1 "                insertSql = 'insert into tableMonitor(date,tableName,maxId,time ) values(%s,%s,( '+maxIdSql +' ),%s )'                cursor.execute(insertSql,[yesterday ,tableName , currtime ])                print(cursor._last_executed)            lastDataSql = 'select date,tableName,maxId from tableMonitor where date in ("'+yesterday.strftime("%Y-%m-%d") +'"'+','+'"'+beforeYesterday.strftime("%Y-%m-%d") +'") and tableName = %s limit 0,2 '            cursor.execute(lastDataSql , tableName)            days = cursor.fetchall()            diff = 0;            if(len(days) == 2) and days[1][2] != None and days[0][2] != None:                if days[1][0] > days[0][0]:                    diff = days[1][2] - days[0][2]                else:                    diff = days[0][2] - days[1][2]            emailContent += "<tr>"            emailContent += "<td align='left' >" + tableName + "</td>"            if diff > 0:                emailContent += "<td align='center' ><font style='color:green;' > %s </font> " %  diff +"</td>"            else:                emailContent += "<td align='center' ><font style='color:red' > %s </font> " %  diff +"</td>"            emailContent += "</tr>"        emailContent +='</table>'        send_mail(mailto_list , '[极客邦SOHO] 数据库更新日报'+yesterday.strftime("%Y-%m-%d") ,emailContent )        conn.commit()    except Exception, e:        send_mail(mailto_list , '[极客邦SOHO] 数据库更新日报'+yesterday.strftime("%Y-%m-%d") ,'监测程序出错 %s' % cursor._last_executed + e.message )        print e        print traceback.format_exc()    cursor.close()    conn.close()checkData()