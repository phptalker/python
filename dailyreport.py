 # -*- coding: utf-8 -*-import confimport timeimport MySQLdbdef conndb():    return MySQLdb.connect(host = conf.mysql_host, user = conf.mysql_user, passwd = conf.mysql_pwd, db = conf.mysql_db, port = int(conf.mysql_port))def updateDailyReport(currdate):    conn = conndb()    cursor = conn.cursor()    try:        cursor.execute('set names utf8')        selectSql  = "select id from daily_report where date = %s "        res = cursor.execute(selectSql,(currdate))        print(res)        if(True != res):            sql = "INSERT INTO daily_report(`date`) values(%s); "            n = cursor.execute(sql,(currdate))            print("新增记录成功: %s" % cursor.lastrowid)        else:            pass        #uuid访问数(pv)        sql1 = 'UPDATE daily_report SET uuidNum  = (SELECT COUNT(*) FROM act_flow0  WHERE daily_report.date = act_flow0.date  GROUP BY `date`)  WHERE  daily_report.date = ' + "'"+currdate+ "'" ;        #uuid数去重(uv)        sql2 = 'UPDATE daily_report SET uuidCount = (SELECT COUNT(DISTINCT(`uuid`)) FROM act_flow0  WHERE daily_report.date = act_flow0.date  GROUP BY act_flow0.`date`) WHERE  daily_report.date = ' + "'"+currdate+ "'" ;        #总用户注册数        sql3 = 'UPDATE daily_report SET userNum  = (SELECT COUNT(*) FROM `user` WHERE daily_report.date = DATE_FORMAT(user.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(user.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'" ;        #程序员数        sql4 = 'UPDATE daily_report SET programmerNum  = (SELECT COUNT(*) FROM `user` left join user_profile on user.user_id = user_profile.user_id WHERE daily_report.date = DATE_FORMAT(user.created_at ,\'%Y-%m-%d\') AND user_profile.user_id is not null  GROUP BY DATE_FORMAT(user.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #        sql5 = 'UPDATE daily_report SET bossNum  = (SELECT COUNT(*) FROM `user` left join user_profile on user.user_id = user_profile.user_id WHERE daily_report.date = DATE_FORMAT(user.created_at ,\'%Y-%m-%d\') AND  user_profile.user_id is  null  GROUP BY DATE_FORMAT(user.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #发起邀约        sql6 = 'UPDATE daily_report SET send_bespeak  = (SELECT COUNT(*) FROM `bespeak` WHERE bespeak.type <> 1 and daily_report.date = DATE_FORMAT(bespeak.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(bespeak.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #同意邀约        sql7 = 'UPDATE daily_report SET agree_bespeak  = (SELECT COUNT(*) FROM `bespeak` WHERE bespeak.type <> 1 and  daily_report.date = DATE_FORMAT(bespeak.updated_at ,\'%Y-%m-%d\') AND bespeak.status =\'agree\'  GROUP BY DATE_FORMAT(bespeak.updated_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #着陆页注册数        sql8 = 'UPDATE daily_report SET landingNum = (SELECT COUNT(*) FROM `user`  WHERE user.source = 2 AND daily_report.date =  DATE_FORMAT(user.created_at ,\'%Y-%m-%d\')   GROUP BY  DATE_FORMAT(user.created_at ,\'%Y-%m-%d\')) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #着陆页uv        sql9 = 'UPDATE daily_report SET landing_page_uv = (SELECT COUNT(*) FROM `uuid2source`  WHERE uuid2source.pageId = 1 AND daily_report.date =  DATE_FORMAT(uuid2source.create_at ,\'%Y-%m-%d\')   GROUP BY  DATE_FORMAT(uuid2source.create_at ,\'%Y-%m-%d\')) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #成功付款订单数        sql10 = 'UPDATE daily_report SET pay_order_num  = IFNULL((SELECT COUNT(ec_log_payment.amount) FROM `ec_order` LEFT JOIN ec_log_payment ON ec_order.order_id = ec_log_payment.order_id WHERE ec_order.type = \'geek\'  AND  daily_report.date = DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\') ),0) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #工作确认订单数        sql11 = 'UPDATE daily_report SET work_complete_num  = (SELECT COUNT(*) FROM `order_log` WHERE order_log.old_value =6 AND order_log.new_value =7   AND daily_report.date = DATE_FORMAT(order_log.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(order_log.created_at ,\'%Y-%m-%d\')) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #支付订单总记录数        sql12 = 'UPDATE daily_report SET payOrderRecordNum  = IFNULL((SELECT COUNT(ec_log_payment.amount) FROM `ec_order` LEFT JOIN ec_log_payment ON ec_order.order_id = ec_log_payment.order_id WHERE    daily_report.date = DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\') ),0)  WHERE  daily_report.date = ' + "'"+currdate+ "'";        #支付金额        sql13 = 'UPDATE daily_report SET payAccountCount  = IFNULL((SELECT SUM(ec_log_payment.amount) FROM `ec_order` LEFT JOIN ec_log_payment ON ec_order.order_id = ec_log_payment.order_id WHERE    daily_report.date = DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\') ),0)  WHERE  daily_report.date = ' + "'"+currdate+ "'";        #提现订单总数        sql14 = 'UPDATE daily_report SET withdrawRecordNum = IFNULL((SELECT COUNT(*) FROM ec_withdraw WHERE   daily_report.date = DATE_FORMAT(ec_withdraw.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_withdraw.created_at ,\'%Y-%m-%d\') ),0)  WHERE  daily_report.date = ' + "'"+currdate+ "'";        #提现总金额        sql15 = 'UPDATE daily_report SET withdrawAccountCount = IFNULL((SELECT SUM(ec_withdraw.amount) FROM ec_withdraw WHERE    daily_report.date = DATE_FORMAT(ec_withdraw.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_withdraw.created_at ,\'%Y-%m-%d\') ),0)  WHERE  daily_report.date = ' + "'"+currdate+ "'";         #退款订单总记录数        sql16 = 'UPDATE daily_report SET refundOrderRecordNum = IFNULL((SELECT COUNT(ec_refund.amount) FROM ec_refund WHERE  daily_report.date = DATE_FORMAT(ec_refund.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_refund.created_at ,\'%Y-%m-%d\') ),0) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #退款总金额        sql17 = 'UPDATE daily_report SET refundAccountCount = IFNULL((SELECT SUM(ec_refund.amount) FROM ec_refund WHERE    daily_report.date = DATE_FORMAT(ec_refund.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_refund.created_at ,\'%Y-%m-%d\') ),0)  WHERE  daily_report.date = ' + "'"+currdate+ "'";        #登录次数        sql18 = 'UPDATE daily_report SET  login_time = (SELECT count(*)  from user_log   WHERE  daily_report.date = DATE_FORMAT(user_log.created_at,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(user_log.created_at ,\'%Y-%m-%d\') )  WHERE  daily_report.date = ' + "'"+currdate+ "'";        #约单被拒绝次数        sql19 = 'UPDATE daily_report SET reject_bespeak  = (SELECT COUNT(*) FROM `bespeak` WHERE bespeak.type <> 1 and  daily_report.date = DATE_FORMAT(bespeak.updated_at ,\'%Y-%m-%d\') AND bespeak.status =\'reject\'  GROUP BY DATE_FORMAT(bespeak.updated_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #自动取消邀约次数        sql20 = 'UPDATE daily_report SET delay_bespeak  = (SELECT COUNT(*) FROM `bespeak` WHERE bespeak.type <> 1 and  daily_report.date = DATE_FORMAT(bespeak.updated_at ,\'%Y-%m-%d\') AND bespeak.status =\'delay\'  GROUP BY DATE_FORMAT(bespeak.updated_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #企业申请次数        sql21 = 'UPDATE daily_report SET team_apply_time  = (SELECT COUNT(*) FROM `team_apply` WHERE   daily_report.date = DATE_FORMAT(team_apply.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(team_apply.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #企业订单数        sql22 = 'UPDATE daily_report SET team_order_time  = (SELECT COUNT(*) FROM `ec_order` WHERE ec_order.type = \'team\' and  daily_report.date = DATE_FORMAT(ec_order.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(ec_order.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #企业托管金额        sql23 = 'UPDATE daily_report SET team_payment_mount  = (SELECT SUM(ec_log_payment.amount) FROM `ec_order` left join ec_log_payment on ec_order.order_id = ec_log_payment.order_id WHERE ec_order.type = \'team\'  and  daily_report.date = DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #兼职申请次数        sql24 = 'UPDATE daily_report SET single_apply_time  = (SELECT COUNT(*) FROM `programmer_profile` WHERE  daily_report.date = DATE_FORMAT(programmer_profile.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(programmer_profile.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #兼职订单数        sql25 = 'UPDATE daily_report SET single_order_time  = (SELECT COUNT(*) FROM `ec_order` WHERE ec_order.type = \'geek\' and  daily_report.date = DATE_FORMAT(ec_order.created_at ,\'%Y-%m-%d\')  GROUP BY DATE_FORMAT(ec_order.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        #兼职托管金额        sql26 = 'UPDATE daily_report SET single_payment_mount  = (SELECT SUM(ec_log_payment.amount) FROM `ec_order` left join ec_log_payment on ec_order.order_id = ec_log_payment.order_id WHERE ec_order.type = \'geek\'  and  daily_report.date = DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\')   GROUP BY DATE_FORMAT(ec_log_payment.created_at ,\'%Y-%m-%d\') ) WHERE  daily_report.date = ' + "'"+currdate+ "'";        cursor.execute(sql1)        cursor.execute(sql2)        cursor.execute(sql3)        cursor.execute(sql4)        cursor.execute(sql5)        cursor.execute(sql6)        cursor.execute(sql7)        cursor.execute(sql8)        cursor.execute(sql9)        cursor.execute(sql10)        cursor.execute(sql11)        cursor.execute(sql12)        cursor.execute(sql13)        cursor.execute(sql14)        cursor.execute(sql15)        cursor.execute(sql16)        cursor.execute(sql17)        cursor.execute(sql18)        cursor.execute(sql19)        cursor.execute(sql20)        cursor.execute(sql21)        cursor.execute(sql22)        cursor.execute(sql23)        cursor.execute(sql24)        cursor.execute(sql25)        cursor.execute(sql26)        conn.commit()    except Exception, e:        print e    cursor.close()    conn.close()currdate = time.strftime("%Y-%m-%d", time.localtime());print currdateupdateDailyReport(currdate)#updateDailyReport("2016-04-14")#updateDailyReport("2016-04-15")#updateDailyReport("2016-04-16")#updateDailyReport("2016-04-17")#updateDailyReport("2016-02-18")#updateDailyReport("2016-02-19")#updateDailyReport("2016-02-20")#updateDailyReport("2016-02-21")#updateDailyReport("2016-02-22")