 # -*- coding: utf-8 -*-import confimport MySQLdbimport utilimport datetimeimport traceback############## 要发给谁，这里发给2个人mailto_list =   ["wangxianghong@looip.cn"]#mailto_list =   ["gaokani@looip.cn","wangxianghong@looip.cn","sunjun@looip.cn","sunming@looip.cn","niuyijing@looip.cn","shihao@looip.cn","zhangyansha@looip.cn","hanmj@looip.cn","max@looip.cn","zhangxibin@looip.cn","jinxin@looip.cn","shixq@looip.cn","robert@looip.cn","gongzl@looip.cn","lihuaqing@looip.cn","wendywang@looip.cn"]def conndb():    return MySQLdb.connect(host=conf.mysql_host, user=conf.mysql_user, passwd=conf.mysql_pwd, db=conf.mysql_db,                           port=int(conf.mysql_port))def checkData():    conn = conndb()    cursor = conn.cursor()    try:        cursor.execute('set names utf8')        today =  datetime.date.today()        # today = today - datetime.timedelta(days=105)        yesterday =  today - datetime.timedelta(days=1)        yesterday = yesterday.strftime("%Y-%m-%d")        #yesterday = "2016-03-15"        lastWeek = util.week_get(today)        weekFrist = lastWeek[0]        weekEnd = lastWeek[1]        regTotalSql = "select count(user_id) from user  where created_at <= %s limit 0,1" ;        applySingleSql = "select count(*) from programmer_profile  where created_at <= %s limit 0,1" ;        orderSingleSql = "select count(*) from ec_order where type='geek' and  created_at <= %s limit 0,1" ;        orderMountSingleSql = "select sum(amount) from ec_order where type='geek' and status in ('paid','done','refund')  and created_at <= %s limit 0,1" ;        applyTeamSql = "select count(*) from team_apply  where created_at <= %s limit 0,1" ;        orderTeamSql = "select count(*) from ec_order where type='team'  and created_at <= %s limit 0,1" ;        orderMountTeamSql = "select sum(amount) from ec_order where type='team' and status in ('paid','done','refund')  and created_at <= %s limit 0,1" ;        lastWeekSql = "select date,userNum,single_apply_time,single_order_time,single_payment_mount,team_apply_time,team_order_time,team_payment_mount  from daily_report where date >= %s and date <= %s";        cursor.execute(regTotalSql ,weekEnd);        regTotalData = cursor.fetchone();        cursor.execute(applySingleSql ,weekEnd);        applySingleData = cursor.fetchone();        cursor.execute(orderSingleSql ,weekEnd);        orderSingleData = cursor.fetchone();        cursor.execute(orderMountSingleSql ,weekEnd);        orderMountSingleData = cursor.fetchone();        cursor.execute(applyTeamSql ,weekEnd);        applyTeamData = cursor.fetchone();        cursor.execute(orderTeamSql,weekEnd);        orderTeamData = cursor.fetchone();        cursor.execute(orderMountTeamSql,weekEnd);        orderMountTeamData = cursor.fetchone();        cursor.execute(lastWeekSql,[weekFrist,weekEnd]);        lastWeekData = cursor.fetchall();        emailContent = weekFrist + " - " + weekEnd +"日极客邦平台数据报告如下：\n"        emailContent += "&nbsp</br>"        emailContent += '<table border ="1" style="text-align: center;" ><th  colspan ="2" >&nbsp;</th>';        weekTableContentDict = {}        if(lastWeekData != None and len(lastWeekData)>0):            regTotalStr        = ""            applySingleStr       = "";            orderSingleStr   = ""            orderMountSingleStr  = ""            applyTeamStr = ""            orderMountTeamStr = ""            orderTeamStr = ""            for day in lastWeekData:                emailContent += "<th> " +str(day[0]) +"</th>"                for i in range(len(day)):                    if  i !=0 :                        if weekTableContentDict.has_key(i):                            weekTableContentDict[i] += (0 if day[i] == None else day[i])                        else:                            weekTableContentDict[i] = (0 if day[i] == None else day[i])                # loginStr += "<td>%d " % ( 0 if (day[1]==None) else  day[1]) +"</td>"                print(day)                regTotalStr += "<td>%d " % ( 0 if (day[1]==None) else  day[1]) +"</td>"                applySingleStr += "<td>%d " % ( 0 if (day[2]==None) else  day[2]) +"</td>"                orderSingleStr += "<td>%d " % ( 0 if (day[3]==None) else  day[3]) +"</td>"                orderMountSingleStr += "<td>%s " % ( 0 if (day[4]==None) else  day[4]) +"</td>"                applyTeamStr += "<td>%d " % ( 0 if (day[5]==None) else  day[5]) +"</td>"                orderTeamStr += "<td>%d " % ( 0 if (day[6]==None) else  day[6]) +"</td>"                orderMountTeamStr += "<td>%s " % ( 0 if (day[7]==None) else  day[7]) +"</td>"                print("<td>%s " % ( 0 if (day[7]==None) else  day[7]) +"</td")            emailContent += "<th style='color: steelblue;' >一周总计</th><th style='color: steelblue;'>截止到周末总数</th>"            emailContent += "<tr><td colspan ='2'>注册总数</td>"+ regTotalStr +"<td style='color: steelblue;'>%d " % weekTableContentDict[1] +"</td><td style='color: steelblue;' > %d " % regTotalData[0] +"</td> </tr>"            emailContent += "<tr><td rowspan='3' >极客</td><td>申请数</td> "+applySingleStr+"<td style='color: steelblue;' >%d " % weekTableContentDict[2] +"</td> <td style='color: steelblue;'>%d " % applySingleData[0] +"</td></tr>"            emailContent += "<tr><td>订单数(邀约发起数)</td>"+orderSingleStr+"<td style='color: steelblue;'>%d " % weekTableContentDict[3] +"</td><td style='color: steelblue;'>%d " % orderSingleData[0] +"</td></tr>"            emailContent += "<tr><td>托管金额</td> "+orderMountSingleStr+"<td style='color: steelblue;'>%s " % weekTableContentDict[4] +"</td><td style='color: steelblue;'>%s " % orderMountSingleData[0] +"</td></tr>"            emailContent += "<tr><td rowspan='3' >团队</td><td>申请数</td> "+applyTeamStr+"<td style='color: steelblue;' >%d " % weekTableContentDict[5] +"<td style='color: steelblue;'>%d " % applyTeamData[0] +"</td></td></tr>"            emailContent += "<tr><td>订单数</td> "+orderTeamStr+"<td style='color: steelblue;' >%d " % weekTableContentDict[6] +"<td style='color: steelblue;'>%d " % orderTeamData[0] +"</td></td></tr>"            emailContent += "<tr><td>托管金额</td> "+orderMountTeamStr+"<td style='color: steelblue;' >%s " % weekTableContentDict[7] +"<td style='color: steelblue;'>%s " % orderMountTeamData[0] +"</td></td></tr>"        #if(lastWeekData != None):            #emailContent += "<tr><td>注册（总数)</td><td>%d " % regTotalData[0] +"</td><td>%d " % ( 0 if (lastDayData[0] ==None) else lastDayData[0]) +"</td></tr>"            #emailContent += "<tr><td>注册（程序员数）</td><td>%d " % regProgTotalData[0] +"</td><td>%d " % ( 0 if (lastDayData[1]==None) else  lastDayData[1]) +"</td></tr>"            #emailContent += "<tr><td>发起邀约</td><td>%d " % sendBespeakData[0] +"</td><td>%d " % ( 0 if (lastDayData[2]==None) else lastDayData[2])  +"</td></tr>"            #emailContent += "<tr><td>达成邀约（同意) </td><td>%d " % agreeBespeakData[0] +"</td><td>%d " % (0 if lastDayData[3]==None else lastDayData[3]) +"</td></tr>"            emailContent +='</table>'            emailContent += "&nbsp</br>"            emailContent += "每日记录详情可登录运营后台 http://system.looip.cn/mcc 查看数据统计栏目"            util.send_mail(mailto_list , '[极客邦SOHO] 数据报告-周报'+weekFrist + " - " + weekEnd ,emailContent )        conn.commit()    except Exception, e:        #send_mail(mailto_list , '[极客邦SOHO] 数据库更新日报'+yesterday.strftime("%Y-%m-%d") ,'监测程序出错 %s' % cursor._last_executed + e.message )        print e        print traceback.format_exc()    cursor.close()    conn.close()checkData()